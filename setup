#!/usr/bin/env bash
# ============================================================================
# ii-niri setup script
# illogical-impulse on Niri - Installation and management
# ============================================================================

if [[ -z "${BASH_VERSION:-}" ]]; then
  exec /usr/bin/env bash "$0" "$@"
fi

cd "$(dirname "$0")"
REPO_ROOT="$(pwd)"

source ./sdata/lib/environment-variables.sh
source ./sdata/lib/functions.sh
source ./sdata/lib/package-installers.sh
source ./sdata/lib/dist-determine.sh
source ./sdata/lib/tui.sh
source ./sdata/lib/conflicts.sh
source ./sdata/lib/migrations.sh
source ./sdata/lib/versioning.sh

prevent_sudo_or_root
set -e

# Cleanup trap
cleanup() {
  if [[ -d "/tmp/buildyay" ]]; then rm -rf /tmp/buildyay; fi
  if [[ -d "/tmp/buildparu" ]]; then rm -rf /tmp/buildparu; fi
}
trap cleanup EXIT INT TERM

#####################################################################################
# Help
#####################################################################################
showhelp_global(){
printf "${STY_CYAN}illogical-impulse on Niri${STY_RST}

Syntax:
  $0 <subcommand> [OPTIONS]...

Subcommands:
  install        Install ii-niri (dependencies + configs)
  update         Update ii-niri (QML code only, respects your configs)
  migrate        Apply optional config migrations (interactive)
  status         Show installation status and pending migrations
  changelog      Show recent changes and release notes
  restore        Restore configs from backup
  
  install-deps   Install only dependencies
  install-setups Run only system setup (groups, services)
  install-files  Copy only config files (legacy, use 'update' instead)

  help           Show this help message

For each subcommand, use -h for details:
  $0 <subcommand> -h

${STY_BOLD}Philosophy:${STY_RST}
  - Your configs are YOURS. We never modify them without asking.
  - 'update' only syncs QML code, never touches your settings.
  - 'migrate' shows exactly what will change and lets you choose.
  - Automatic backups before any config changes.

${STY_BOLD}${STY_CYAN}Repository: https://github.com/snowarch/quickshell-ii-niri${STY_RST}
"
}

#####################################################################################
# Parse subcommand
#####################################################################################

# If no arguments, launch TUI
if [ $# -eq 0 ]; then
    tui_main_menu
    RET=$?
    case $RET in
        1) set -- "install" ;;
        2) set -- "update" ;;
        3) set -- "status" ;;
        4) set -- "migrate" ;;
        5) set -- "changelog" ;;
        *) exit 0 ;;
    esac
fi

case $1 in
  help|--help|-h)
    showhelp_global
    exit 0
    ;;
  install|install-deps|install-setups|install-files)
    SUBCMD_NAME=$1
    SUBCMD_DIR=./sdata/subcmd-install
    shift
    ;;
  update)
    SUBCMD_NAME="update"
    SUBCMD_DIR=./sdata/subcmd-install
    shift
    ;;
  migrate)
    SUBCMD_NAME="migrate"
    shift
    ;;
  status)
    SUBCMD_NAME="status"
    shift
    ;;
  changelog)
    SUBCMD_NAME="changelog"
    shift
    ;;
  restore)
    SUBCMD_NAME="restore"
    shift
    ;;
  *)
    printf "${STY_RED}Unknown subcommand \"$1\".${STY_RST}\n"
    showhelp_global
    exit 1
    ;;
esac

#####################################################################################
# Load options
#####################################################################################
if [[ -f "${SUBCMD_DIR}/options.sh" ]]; then
  source "${SUBCMD_DIR}/options.sh"
fi

#####################################################################################
# Run subcommand
#####################################################################################
case ${SUBCMD_NAME} in
  install)
    # Detect distro
    detect_distro
    pause
    
    # Greeting
    source ${SUBCMD_DIR}/0.greeting.sh
    
    # Check for conflicts
    check_conflicts
    
    # 1. Dependencies
    if [[ "${SKIP_ALLDEPS}" != true ]]; then
      source ${SUBCMD_DIR}/1.deps-router.sh
    fi
    
    # 2. System setup
    if [[ "${SKIP_ALLSETUPS}" != true ]]; then
      source ${SUBCMD_DIR}/2.setups.sh
    fi
    
    # 3. Config files
    if [[ "${SKIP_ALLFILES}" != true ]]; then
      source ${SUBCMD_DIR}/3.files.sh
    fi
    ;;
    
  install-deps)
    detect_distro
    pause
    if [[ "${SKIP_ALLDEPS}" != true ]]; then
      source ${SUBCMD_DIR}/1.deps-router.sh
    fi
    ;;
    
  install-setups)
    detect_distro
    pause
    if [[ "${SKIP_ALLSETUPS}" != true ]]; then
      source ${SUBCMD_DIR}/2.setups.sh
    fi
    ;;
    
  install-files)
    detect_distro
    pause
    if [[ "${SKIP_ALLFILES}" != true ]]; then
      source ${SUBCMD_DIR}/3.files.sh
    fi
    ;;
    
  update)
    # Safe update: only syncs QML code, never touches user configs
    detect_distro
    
    # Check if update is needed
    installed_ver=$(get_installed_version)
    installed_commit=$(get_installed_commit)
    repo_ver=$(get_repo_version)
    repo_commit=$(get_repo_commit)
    
    if [[ "$installed_ver" == "$repo_ver" && "$installed_commit" == "$repo_commit" ]]; then
      echo ""
      echo -e "${STY_GREEN}${STY_BOLD}✓ Already up to date${STY_RST}"
      echo -e "  Version: $installed_ver ($installed_commit)"
      echo ""
      
      # Still check for pending migrations
      pending_count=$(count_pending_migrations)
      if [[ "$pending_count" -gt 0 ]]; then
        echo -e "${STY_YELLOW}Note: $pending_count pending migration(s) available.${STY_RST}"
        echo -e "Run: ${STY_CYAN}./setup migrate${STY_RST} to review"
      fi
      exit 0
    fi
    
    echo ""
    echo -e "${STY_CYAN}${STY_BOLD}Updating ii-niri${STY_RST}"
    echo -e "  From: $installed_ver ($installed_commit)"
    echo -e "  To:   $repo_ver ($repo_commit)"
    echo ""
    
    pause
    export IS_UPDATE=true
    
    # Check for new dependencies (optional)
    if [[ "${SKIP_ALLDEPS}" != true ]]; then
      source ${SUBCMD_DIR}/1.deps-router.sh
    fi
    
    # Sync QML code only (no config migrations)
    export SKIP_MIGRATIONS=true
    if [[ "${SKIP_ALLFILES}" != true ]]; then
      source ${SUBCMD_DIR}/3.files.sh
    fi
    
    # Update version file with new format
    set_installed_version "$repo_ver" "$repo_commit" "git"
    
    # Show pending migrations hint
    pending_count=$(count_pending_migrations)
    if [[ "$pending_count" -gt 0 ]]; then
      echo ""
      echo -e "${STY_YELLOW}${STY_BOLD}┌─ Optional Migrations Available${STY_RST}"
      echo -e "${STY_YELLOW}│${STY_RST}"
      echo -e "${STY_YELLOW}│${STY_RST}  There are ${STY_BOLD}$pending_count${STY_RST} config migrations available."
      echo -e "${STY_YELLOW}│${STY_RST}  These add new features but are ${STY_BOLD}optional${STY_RST}."
      echo -e "${STY_YELLOW}│${STY_RST}"
      echo -e "${STY_YELLOW}│${STY_RST}  Run: ${STY_CYAN}./setup migrate${STY_RST} to review and apply"
      echo -e "${STY_YELLOW}│${STY_RST}"
      echo -e "${STY_YELLOW}└──────────────────────────────${STY_RST}"
    fi
    
    echo ""
    echo -e "${STY_GREEN}${STY_BOLD}✓ Update complete${STY_RST}"
    echo -e "  Now running: $repo_ver ($repo_commit)"
    ;;
    
  migrate)
    # Interactive migration of user configs
    if [[ "$1" == "-h" || "$1" == "--help" ]]; then
      echo "Usage: $0 migrate [OPTIONS]"
      echo ""
      echo "Interactively apply config migrations."
      echo "Shows exactly what will change and lets you choose."
      echo "Automatic backup before any changes."
      echo ""
      echo "Options:"
      echo "  --list     List all migrations and their status"
      echo "  --apply-all  Apply all pending migrations without prompts"
      echo "  -h, --help   Show this help"
      exit 0
    fi
    
    if [[ "$1" == "--list" ]]; then
      show_migrations_status
      exit 0
    fi
    
    if [[ "$1" == "--apply-all" ]]; then
      for migration_id in $(get_pending_migrations); do
        apply_migration "$migration_id"
      done
      exit 0
    fi
    
    run_migrations_interactive
    ;;
    
  status)
    # Show installation status with new versioning system
    show_version_status
    
    echo ""
    show_migrations_status
    
    echo ""
    echo -e "${STY_BOLD}Backups:${STY_RST}"
    backups=($(list_backups))
    if [[ ${#backups[@]} -eq 0 ]]; then
      echo "  No backups found"
    else
      for backup in "${backups[@]:0:5}"; do
        echo "  - $backup"
      done
      if [[ ${#backups[@]} -gt 5 ]]; then
        echo "  ... and $((${#backups[@]} - 5)) more"
      fi
    fi
    ;;
    
  changelog)
    # Show changelog
    if [[ "$1" == "-h" || "$1" == "--help" ]]; then
      echo "Usage: $0 changelog [LINES]"
      echo ""
      echo "Show recent changes and release notes."
      echo ""
      echo "Options:"
      echo "  LINES      Number of lines to show (default: 50)"
      echo "  -h, --help Show this help"
      exit 0
    fi
    
    lines="${1:-50}"
    show_changelog "$lines"
    ;;
    
  restore)
    # Restore from backup
    if [[ "$1" == "-h" || "$1" == "--help" ]]; then
      echo "Usage: $0 restore [TIMESTAMP]"
      echo ""
      echo "Restore configs from a backup."
      echo "If no timestamp given, shows available backups."
      exit 0
    fi
    
    if [[ -z "$1" ]]; then
      echo -e "${STY_CYAN}Available backups:${STY_RST}"
      echo ""
      for backup in $(list_backups); do
        echo "  $backup"
      done
      echo ""
      echo "Usage: $0 restore <timestamp>"
    else
      restore_backup "$1"
    fi
    ;;
esac
